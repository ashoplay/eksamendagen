<div class="joke-container">
    <% if (typeof error !== 'undefined') { %>
        <div class="error-message"><%= error %></div>
    <% } else { %>
        <div class="joke-card">
            <div class="joke-header">
                <% if (isAuthenticated) { %>
                    <div class="favorite-container">
                        <button class="favorite-btn <%= isFavorite ? 'active' : '' %>" onclick="toggleFavorite('<%= joke._id %>')">
                            <i class="fas fa-heart"></i>
                            <span class="favorite-text">Favoritt</span>
                        </button>
                    </div>
                <% } %>
            </div>
            <div class="joke-setup">
                <%= joke.setup %>
            </div>
            <div class="joke-punchline" id="punchline">
                <button onclick="revealPunchline()" id="reveal-btn" class="reveal-btn">
                    <i class="fas fa-lightbulb"></i> Vis poenget
                </button>
                <p class="hidden" id="punchline-text"><%= joke.punchline %></p>
            </div>
            <div class="rating-section">
                <% if (isAuthenticated) { %>
                    <div class="emoji-rating">
                        <div class="emoji-group">
                            <button class="emoji-btn" data-rating="1" onclick="setRating(1)">ðŸ˜¢</button>
                            <span class="rating-points">1 poeng</span>
                        </div>
                        <div class="emoji-group">
                            <button class="emoji-btn" data-rating="2" onclick="setRating(2)">ðŸ˜•</button>
                            <span class="rating-points">2 poeng</span>
                        </div>
                        <div class="emoji-group">
                            <button class="emoji-btn" data-rating="3" onclick="setRating(3)">ðŸ˜Š</button>
                            <span class="rating-points">3 poeng</span>
                        </div>
                        <div class="emoji-group">
                            <button class="emoji-btn" data-rating="4" onclick="setRating(4)">ðŸ˜„</button>
                            <span class="rating-points">4 poeng</span>
                        </div>
                        <div class="emoji-group">
                            <button class="emoji-btn" data-rating="5" onclick="setRating(5)">ðŸ¤£</button>
                            <span class="rating-points">5 poeng</span>
                        </div>
                    </div>
                    <button onclick="submitRating('<%= joke._id %>')" id="rate-btn">
                        <%= userRating ? 'Oppdater vurdering' : 'Send vurdering' %>
                    </button>
                    <div class="rating-stats" id="rating-stats">
                        <div class="average-rating">
                            Gjennomsnittlig vurdering: <span class="rating-value"><%= Number(averageRating).toFixed(1) %> poeng</span>
                        </div>
                        <div class="rating-count">(<%= totalRatings %> vurdering<%= totalRatings !== 1 ? 'er' : '' %>)</div>
                    </div>
                <% } else { %>
                    <p class="login-prompt">
                        <a href="/login">Logg inn</a> eller <a href="/register">registrer deg</a> for Ã¥ vurdere vitser og lagre favoritter!
                    </p>
                <% } %>
            </div>
            <div class="share-buttons">
                <button class="share-btn" onclick="shareJoke('twitter')">
                    <i class="fab fa-twitter"></i> Del pÃ¥ Twitter
                </button>
                <button class="share-btn" onclick="shareJoke('copy')">
                    <i class="fas fa-copy"></i> Kopier
                </button>
            </div>
            <button onclick="location.reload()" class="next-joke-btn">
                <i class="fas fa-forward"></i> Neste vits
            </button>
        </div>
    <% } %>
</div>

<style>
.favorite-container {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.favorite-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    background: none;
    border: 2px solid var(--heart-color);
    color: var(--heart-color);
    transition: all 0.3s ease;
}

.favorite-btn:hover, .favorite-btn.active {
    background-color: var(--heart-color);
    color: white;
}

.favorite-text {
    font-size: 0.9rem;
    font-weight: 500;
}

.emoji-rating {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin: 1rem 0;
}

.emoji-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
}

.rating-points {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.8;
}

.rating-stats {
    text-align: center;
    margin-top: 1rem;
    padding: 1rem;
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    display: <%= totalRatings > 0 ? 'block' : 'none' %>;
}

.rating-value {
    font-weight: bold;
    color: var(--accent-color);
}

.rating-count {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
    margin-top: 0.5rem;
}

/* Add styles for disabled button */
button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* Add animation for rating update */
@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Add highlight animation for rating updates */
@keyframes highlight {
    0% { background-color: var(--accent-color); color: white; }
    100% { background-color: rgba(0, 0, 0, 0.05); color: var(--text-color); }
}

.highlight {
    animation: highlight 1s ease-out;
}

.rating-stats {
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Add styles for error messages */
.error-message {
    background-color: #ffebee;
    color: #c62828;
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 4px;
    text-align: center;
}
</style>

<script>
    // Initialize Socket.IO first
    const socket = io();

    // Debug logging for Socket.IO
    socket.on('connect', () => {
        console.log('Socket.IO tilkoblet');
        joinJokeRoom();
    });

    socket.on('connect_error', (error) => {
        console.error('Socket.IO tilkoblingsfeil:', error);
    });

    function joinJokeRoom() {
        const jokeId = '<%= joke._id %>';
        console.log('Blir med i vitserom:', jokeId);
        socket.emit('join joke room', jokeId);
    }

    // Listen for rating updates
    socket.on('rating update', function(data) {
        console.log('Mottok vurderingsoppdatering:', data);
        if (data.jokeId === '<%= joke._id %>') {
            console.log('Oppdaterer visning med nye vurderingsdata');
            updateRatingDisplay(data.averageRating, data.totalRatings);
        }
    });

    function revealPunchline() {
        document.getElementById('punchline-text').classList.remove('hidden');
        document.getElementById('reveal-btn').classList.add('hidden');
    }

    const currentRating = <%= typeof userRating === 'number' ? userRating : 3 %>;
    console.log('Initial vurdering:', currentRating);
    window.currentRating = currentRating;
    
    function setRating(rating) {
        console.log('Setter vurdering til:', rating);
        window.currentRating = rating;
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (parseInt(btn.dataset.rating) === rating) {
                btn.classList.add('selected');
            }
        });
    }

    function updateRatingDisplay(averageRating, totalRatings) {
        console.log('Oppdaterer vurderingsvisning:', { averageRating, totalRatings });
        const ratingStats = document.getElementById('rating-stats');
        const formattedAverage = Number(averageRating).toFixed(1);
        
        ratingStats.innerHTML = `
            <div class="average-rating">
                Gjennomsnittlig vurdering: <span class="rating-value">${formattedAverage} poeng</span>
            </div>
            <div class="rating-count">(${totalRatings} vurdering${totalRatings !== 1 ? 'er' : ''})</div>
        `;
        
        ratingStats.style.display = 'block';
        ratingStats.classList.remove('highlight');
        void ratingStats.offsetWidth;
        ratingStats.classList.add('highlight');
    }

    function submitRating(jokeId) {
        if (!window.currentRating) {
            console.error('Ingen vurdering valgt');
            alert('Vennligst velg en vurdering fÃ¸rst');
            return;
        }

        console.log('Sender vurdering:', { jokeId, rating: window.currentRating });
        const rateBtn = document.getElementById('rate-btn');
        rateBtn.disabled = true;
        rateBtn.textContent = 'Sender...';

        fetch('/rate-joke', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jokeId: jokeId,
                rating: window.currentRating
            })
        })
        .then(response => {
            console.log('Mottok svar:', response.status);
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || `HTTP-feil! status: ${response.status}`);
                }
                return data;
            });
        })
        .then(data => {
            console.log('Vurdering sendt:', data);
            if (data.success) {
                updateRatingDisplay(data.averageRating, data.totalRatings);
                rateBtn.textContent = 'Vurdering sendt!';
                setTimeout(() => {
                    rateBtn.textContent = 'Oppdater vurdering';
                    rateBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.error || 'Ukjent feil oppstod');
            }
        })
        .catch(error => {
            console.error('Feil ved sending av vurdering:', error);
            rateBtn.textContent = 'Kunne ikke sende';
            alert(`Feil: ${error.message}`);
            setTimeout(() => {
                rateBtn.textContent = 'Send vurdering';
                rateBtn.disabled = false;
            }, 2000);
        });
    }

    function toggleFavorite(jokeId) {
        fetch('/toggle-favorite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ jokeId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const favoriteBtn = document.querySelector('.favorite-btn');
                favoriteBtn.classList.toggle('active');
            }
        });
    }

    function shareJoke(platform) {
        const setup = '<%= joke.setup %>';
        const punchline = '<%= joke.punchline %>';
        const text = `${setup}\n\n${punchline}\n\nDelt fra Vitsevurdering`;
        
        if (platform === 'twitter') {
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`);
        } else if (platform === 'copy') {
            navigator.clipboard.writeText(text).then(() => {
                alert('Vits kopiert til utklippstavlen!');
            });
        }
    }
</script> 